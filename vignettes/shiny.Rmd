---
title: "Using Microsoft365R in a Shiny app"
author: Hong Ooi
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Shiny}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{utf8}
---

This vignette describes how to incorporate Microsoft365R and interactive authentication with Azure Active Directory (AAD) into a Shiny web app. There are a few steps involved:

- Register your app with AAD
- Use the app ID to authenticate and get an OAuth token
- Pass the token to the Microsoft365R functions

## App registration

The default Microsoft365R app registration only works when the package is used on a local machine; it does not support running in a remote server. Because of this, when you use Microsoft365R inside a Shiny app, you (or your friendly local sysadmin) must register that app in AAD.

The main things to set in your app registration are:

- The **redirect URI** of your app, ie, your user-facing site address. For example if your app is hosted in shinyapps.io, this would be a URL of the form `https://youraccount.shinyapps.io/appname`. If your app uses a special port number rather than the default port 80, don't forget to include that as well. It's possible to set more than one redirect, so you can reuse a single app registration for multiple Shiny apps. You can also include the standard `http://localhost:1410` redirect if you want to support authentication on a local machine.

- The **type of redirect**, either native (mobile & desktop) or webapp. The difference between these is that you must supply a client secret when authenticating with a webapp redirect, which is not required for a mobile & desktop redirect. It's recommended that you should use a webapp redirect when registering a Shiny app, as the client secret helps prevent third parties from hijacking your app registration.

- The **intended audience** of your app, ie, who is allowed to use it. This can be only members of your AAD tenant; members of any AAD tenant; or anyone with a Microsoft account (including personal accounts).

Registering an app can be done either in the [Azure portal](https://portal.azure.com/) or using the [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli). In general, the Portal is easier for interactive use, while the CLI is intended to be called in scripts.


## Shiny code skeleton

```r
library(AzureAuth)
library(AzureGraph)
library(Microsoft365R)
library(shiny)
library(shinyjs)

tenant <- "your-tenant-here"

# the ID of the app registration you created
app <- "your-app-id-here"

# if your app reg has a 'webapp' redirect, it requires a client secret (password)
# you should NEVER put secrets in code: here we get it from an environment variable
# leave the environment variable unset if you have a 'desktop & mobile' redirect
pwd <- Sys.getenv("SHINY_APP_SECRET", NULL)

# set this to the site URL of your app once it is deployed
redirect <- "https://example.com/mysite"
port <- httr::parse_url(redirect)$port
options(shiny.port=if(is.null(port)) 80 else as.numeric(port))

# get the Graph permissions listed for the app
# also retrieve an ID token
resource <- c("https://graph.microsoft.com/.default", "openid")

# a simple UI: display the user's OneDrive
ui <- fluidPage(
    verbatimTextOutput("drv")
)

ui_func <- function(req)
{
    opts <- parseQueryString(req$QUERY_STRING)
    if(is.null(opts$code))
    {
        auth_uri <- build_authorization_uri(resource, tenant, app, redirect_uri=redirect, version=2)
        redir_js <- sprintf("location.replace(\"%s\");", auth_uri)
        tags$script(HTML(redir_js))
    }
    else ui
}

server <- function(input, output, session)
{
    opts <- parseQueryString(isolate(session$clientData$url_search))
    if(is.null(opts$code))
        return()

    token <- get_azure_token(resource, tenant, app, password=pwd, auth_type="authorization_code",
                             authorize_args=list(redirect_uri=redirect), version=2,
                             use_cache=FALSE, auth_code=opts$code)

    # display the contents of the user's OneDrive root folder
    drv <- ms_graph$
        new(token=token)$
        get_user()$
        get_drive()
    output$drv <- renderPrint(drv$list_files())
}

shinyApp(ui_func, server)
```
